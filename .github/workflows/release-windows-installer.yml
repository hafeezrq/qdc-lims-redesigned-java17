name: Release Windows Installer

on:
  push:
    tags:
      - "LIMS_v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to build (e.g., LIMS_v1_0_0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-windows-installer:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag && format('refs/tags/{0}', inputs.tag) || github.ref }}

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Download JavaFX jmods
        shell: pwsh
        run: |
          $version = "21.0.2"
          $url = "https://download.java.net/java/GA/javafx21.0.2/0dc89a29ffa34addbe3057926acea09a/GPL/openjfx-21.0.2_windows-x64_bin-jmods.zip"
          $zipPath = Join-Path $env:RUNNER_TEMP "javafx-jmods.zip"
          Invoke-WebRequest -Uri $url -OutFile $zipPath
          $extract = Join-Path $env:RUNNER_TEMP "javafx"
          Expand-Archive -Path $zipPath -DestinationPath $extract
          $dir = Get-ChildItem $extract -Directory | Select-Object -First 1
          if (-not $dir) { throw "JavaFX jmods directory not found after extract." }
          "JAVA_FX_JMODS=$($dir.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Build and package (jpackage)
        shell: cmd
        run: |
          call mvnw.cmd -B -DskipTests "-Djavafx.jmods.path=%JAVA_FX_JMODS%" package jpackage:jpackage

      - name: Verify boot jar and installer
        shell: pwsh
        run: |
          Get-ChildItem -Path target | Format-Table -AutoSize
          if (-not (Get-ChildItem -Path target -Filter "*.jar.original" -File)) {
            Write-Error "Boot jar repackage did not run (missing .jar.original)"
            exit 1
          }
          if (-not (Get-ChildItem -Path target -Filter "*.exe" -File)) {
            Write-Error "Installer exe not found in target"
            exit 1
          }

      - name: Publish installer to Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "target/*.exe"
          allowUpdates: true
          replacesArtifacts: true
          artifactErrorsFailBuild: true
          tag: ${{ inputs.tag || github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
